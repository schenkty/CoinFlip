<!DOCTYPE HTML>

<html>

<head>
  <link rel="stylesheet" href="/coin.css" type="text/css">
  <link href="https://fonts.googleapis.com/css?family=Cinzel:400,700&display=swap" rel="stylesheet">
  <script type="text/javascript" src="/bundle.js"></script>
  <script type="text/javascript">
    let currentGameID;
    let ws;
    let currentGame = {};
    let headsCount = 0;
    let tailsCount = 0;

    function deferFn(callback, ms) {
        setTimeout(callback, ms);
    }

    function processResult(result) {
      const status = document.querySelector('.status');
      const heads = document.querySelector('.headsCount');
      const tails = document.querySelector('.tailsCount');
      const headsCoin = document.querySelector('.heads');
      const tailsCoin = document.querySelector('.tails');

      if (result === 'heads') {
        headsCount++;
        heads.innerText = headsCount;
        tailsCoin.style.display = 'none';
        headsCoin.style.display = 'block';
        status.innerText = `You Won!`;
      } else {
        tailsCount++;
        tails.innerText = tailsCount;
        headsCoin.style.display = 'none';
        tailsCoin.style.display = 'block';
        status.innerText = `You Lost!`;
      }
    }

    function Flip() {
      const coin = document.querySelector('#coin');

      // open up coin flip socket
      ws = new WebSocket("ws://127.0.0.1:8080");

      ws.onopen = function() {
        // Web Socket is connected, send data using send()
        ws.send(JSON.stringify({
          "event": "subscribe"
        }));
      };

      ws.onmessage = function(message) {
        const data = JSON.parse(message.data);
        switch (data.event) {
          case "subscribed":
            // reset local game object
            currentGame = {};
            currentGameID = data.game;
            coin.setAttribute('class', '');

            ws.send(JSON.stringify({
              "event": "newGame",
              "game": currentGameID
            }));
            break;
          case "houseHash":
            if (currentGame.hasOwnProperty('houseHash')) {
              alert("House is flawed!");
            } else {
              // save house hash to local object
              currentGame.houseHash = data.hash;

              // generate player random and hash
              let playerRandom = generateRandom();
              currentGame.playerRandom = playerRandom;

              // send player random hash to server
              ws.send(JSON.stringify({
                "event": "playerRandom",
                "game": currentGameID,
                "playerRandom": playerRandom
              }));
            }
            break;
          case "houseRandom":
            // verify that the house random is the same as the house hash
            if (currentGame.houseHash === toHash(data.houseRandom)) {
              console.log('House is Verified!');
              let final = `final${  data.houseRandom  }${ currentGame.playerRandom }`;
              let finalHash = toHash(final);
              let num = parseInt(finalHash.charAt(37), 16);

              if (oddOrEven(num)) {
                // house lost
                currentGame.won = true;
              } else {
                // house won
                currentGame.won = false;
              }
            } else {
              alert('House is flawed!');
            }
          case "gameUpdate":
            // notify player if we won or lost.
            if (data.won === true && currentGame.won === true) {
              // player won
              console.log("You Won!!");
              deferFn(function () {
                  coin.setAttribute('class', 'animate-' + 'heads');
                  deferFn(processResult.bind(null, 'heads'), 2900);
              }, 100);
            } else if (data.won === false && currentGame.won == false) {
              // player lost
              console.log("You Lost!");
              deferFn(function () {
                  coin.setAttribute('class', 'animate-' + 'tails');
                  deferFn(processResult.bind(null, 'tails'), 2900);
              }, 100);
            }
          case "ping":
            break;
          default:
            break;
        }
      };

      ws.onclose = function() {
        // websocket is closed.
        console.log("Flip Socket Connection is closed...");
      };
    }
  </script>
</head>

<body>
  <div id="coin" class=''>
    <div class="heads"></div>
    <div class="tails"></div>
  </div>
  <button class='btn' onclick="Flip()">Toss the coin!</button>

  <p class="heads-tails-counter">Heads:<span class="headsCount">0</span> Tails:<span Class="tailsCount">0</span></p>
  <p><span Class="status"></span></p>
</body>

</html>
